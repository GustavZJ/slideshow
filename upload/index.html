<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billedeupload</title>
    <link rel="stylesheet" href="/src/scss/main.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.js"></script>
</head>
<body>
    <div id="imageUploadCont">
        <form id="uploadForm" method="get" enctype="multipart/form-data">
            <div id="uploadImageFile">
                <input type="file" id="uploadImageInput" multiple="multiple" accept="image/*" name="files[]">
                <label for="uploadImageInput" id="uploadLabel">Klik for at uploade</label>
            </div>
            <input class="labelBtn btnWhite" type="submit" value="Upload" id="submitBtn" disabled>
            <button class="labelBtn btnRed" type="button" id="clearBtn" disabled>Ryd</button>
        </form>
        <p id="previewText">Billeder:</p>
        <div id="imagePreviewCont"></div>
    </div>

    <form id="hiddenForm" method="get" enctype="multipart/form-data">
        <input type="file" id="hiddenImageInput" multiple="multiple" accept="image/*" name="hidden[]">
        <input id="hiddenSubmit" type="submit" value="Upload">
    </form>

    <script type="module">
        import { messageFade } from '/src/js/errorMessage.js'

        let max_file_uploads = 0;
        let file_count = 0;
        // Function to run php script in background
        jQuery(document).ready(function ($) {
            async function createFile(filePath){
                    let response = await fetch(filePath);
                    let data = await response.blob();
                    let metadata = {
                        type: data.type
                    };
                    return new File([data], (+new Date * Math.random()).toString(36).substring(0,6) + '.jpg', metadata);
                }
            $.ajax({
                type: 'POST',
                url: '/src/php/default_val.php',
                success: function (key_val) {
                const key_val_object = Object.entries(key_val).reduce((obj, [key, val]) => {
                    obj[key] = val;
                    return obj;
                }, {});

                    max_file_uploads = key_val_object[max_file_uploads];
                }
            });
            
            $('#hiddenForm').submit(function (event) {
                event.preventDefault();

                const formData = new FormData(this); // Create FormData object

                $.ajax({
                    type: 'POST',
                    url: '/src/php/convertHEIC.php',
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function (response) {
                        const allFiles = [];
                        (async function () {
                            for await (const filePath of response['files']) {
                               // Add the new file to the array of files
                               const file = await createFile(filePath.slice(18)).then(function(result) {allFiles.push(result)});
                            }

                            // Create a new FileList from the combined array of files
                            const combinedFileList = new DataTransfer();
                            allFiles.forEach(fileItem => {
                                combinedFileList.items.add(fileItem);
                            });

                            // Set the files property of the file input to the combined FileList
                            document.getElementById('uploadImageInput').files = combinedFileList.files;
                            document.getElementById('uploadImageInput').dispatchEvent(new Event('change'));

                            document.getElementById('hiddenImageInput').value = '';
                        })();
                    },
                        error: function () {
                            clearInterval(dots);
                            messageFade('error', 'Noget gik galdt! Prøv igen.');
                            $('#uploadImageInput').removeAttr('disabled');
                            $('#submitBtn').removeAttr('disabled');
                            $('#submitBtn').val('Upload');
                            $('#clearBtn').removeAttr('disabled');
                            $('#uploadLabel').css('cursor', 'pointer');
                        }
                })
            });
            
            $('#uploadForm').submit(function (event) {
                event.preventDefault(); // Prevent default form submission
                file_count = document.getElementById('uploadImageInput').files.length;
                const formData = new FormData(this); // Create FormData object

                $('#uploadImageInput').attr('disabled', true);
                $('#submitBtn').attr('disabled', true);
                $('#clearBtn').attr('disabled', true);
                $('#uploadLabel').css('cursor', 'default');
                $("#submitBtn").val('Uploader');

                const dots = window.setInterval(function() {
                    const dotCount = ($("#submitBtn").val().match(/\./g) || []).length;

                    if (dotCount >= 3) {
                        $("#submitBtn").val('Uploader');
                    } else {
                        $("#submitBtn").val($("#submitBtn").val() + '.');
                    }
                }, 500);
                
                if (file_count > max_file_uploads) {
                    clearInterval(dots);
                    messageFade("error", `Antallet af filer du prøver at uploade (${file_count}) overskrider grænsen sat af administratorerne (${max_file_uploads}).`);
                    $('#uploadImageInput').removeAttr('disabled');
                    $('#submitBtn').removeAttr('disabled');
                    $('#clearBtn').removeAttr('disabled');
                    $('#submitBtn').val('Upload');
                    $('#uploadLabel').css('cursor', 'pointer');

                } else {
                    $.ajax({
                        type: 'POST',
                        url: 'upload.php',
                        data: formData,
                        contentType: false,
                        processData: false,
                        success: function (response) {
                            clearInterval(dots);
                            $('#uploadImageInput').removeAttr('disabled');
                            $('#submitBtn').val('Upload');
                            $('#uploadLabel').css('cursor', 'pointer');
                            $('#submitBtn').attr('disabled', true);
                            $('#clearBtn').attr('disabled', true);

                            let allSuccess = true;
                            let errMsg = '';
                            let counter = 0;

                            for (const [key, value] of Object.entries(response)) {
                                if (value.includes('success')) {
                                    counter += 1;
                                }
                                else {
                                    allSuccess = false;
                                    errMsg += `${key}: ${[...value].join(' og ')}.<br>`;
                                }
                            }

                            if (allSuccess) {
                                let msg = '';
                                if (counter > 1) {
                                    msg += `Alle ${counter} billede(r) blev uploadet uden fejl.`
                                }
                                else {
                                    msg += `${counter} billede blev uploadet uden fejl.`
                                }
                                messageFade('success', msg);
                            }
                            else if (counter > 0) {
                                errMsg = `${counter} billede(r) blev uploadet uden fejl.<br>Men:<br>${errMsg}`;
                                messageFade('error', errMsg);
                            }
                            else {
                                errMsg = `Fejl:<br>${errMsg}`;
                                messageFade('error', errMsg);
                            }

                            for (let i = document.getElementById('imagePreviewCont').childElementCount - 1; i >= 0; i--) {
                                document.getElementById('imagePreviewCont').children[i].remove();
                                document.getElementById('uploadImageInput').value = '';
                                document.getElementById('previewText').style.display = 'none';
                            }
                        },
                        error: function () {
                            clearInterval(dots);
                            messageFade('error', 'Noget gik galdt! Prøv igen.');
                            $('#uploadImageInput').removeAttr('disabled');
                            $('#submitBtn').removeAttr('disabled');
                            $('#submitBtn').val('Upload');
                            $('#clearBtn').removeAttr('disabled');
                            $('#uploadLabel').css('cursor', 'pointer');
                        }
                    });
                }
            });
        });
    </script>
    
    <script type="module" src="/src/js/errorMessage.js"></script>
    <script type="module" src="/src/js/imageManager.js"></script>
    <script src="/src/js/topbar.js"></script>
</body>
</html>